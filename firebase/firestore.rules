rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isServiceAccount() {
      return request.auth.token.email == "screens@bcc.online";
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/user-groups/bcc/permissions/$(request.auth.token.personId));
    }

    function isPerson(personId) {
      return request.auth.token.personId == personId;
    }

    function isLoggedIn() {
      return request.auth != null;
    }
    
    function fieldsExist(required, optional) {
      let allAllowedFields = required;
      if (optional) allAllowedFields = required.concat(optional);
      return request.resource.data.keys().hasAll(required) &&
        request.resource.data.keys().hasOnly(allAllowedFields);
    }

    function isUpdatingFields(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }

    match /user-groups/bcc {
      allow read: if true;
      allow write: if false;

      match /users/{userId} {
        allow read: if isServiceAccount();
        allow read, update: if isAdmin() || isPerson(userId);
        allow write: if false;
      }
    }

    match /{documentId=**} {
      allow read, write: if isAdmin();
    }

    match /churches/{churchId} {
      allow read: if isLoggedIn();
    }

    match /competitions/{competitionId=**} {
      allow read: if isLoggedIn();
    }

    match /buk-games/{bukGameId=**} {
      allow read: if isLoggedIn();
    }

    match /configs/{configId=**} {
      allow read: if isLoggedIn();
    }

    match /templates/{templateId=**} {
      allow read: if isServiceAccount();
    }

    match /event-groups/{egId=**} {
      allow read: if isServiceAccount();
    }

    match /events/{eventId} {

      allow get: if isLoggedIn();

      match /checkins/{checkinId} {
        allow create: if fieldsExist(['checkedInBy', 'coords', 'personId', 'timestamp'])
        && isPerson(request.resource.data.checkedInBy)
        && request.resource.data.personId == checkinId;
        allow update: if (isPerson(checkinId) || isPerson(resource.data.checkedInBy)) && !isUpdatingFields(['personId', 'checkedInBy']);
        allow get: if isPerson(checkinId) || isPerson(resource.data.checkedInBy);
        allow list: if isServiceAccount();
        allow list, delete: if isAdmin();
      }
      match /gameboard/{gameboardId=**} {
        allow read: if isLoggedIn();
      }
      match /liveboard/{componentId=**} {
        allow read: if isLoggedIn();
      }

      match /program/{programId=**} {
        allow read: if isLoggedIn();
      }
      match /questions/{questionId=**} {
        allow read: if isLoggedIn();
      }
      match /inquiries-queue/{feedItemId=**} {
        allow read: if isServiceAccount();
      }
      match /feed-approved/{feedItemId=**} {
        allow read: if isServiceAccount();
      }
      match /feed-outgoing/{feedItemId=**} {
        allow read: if isServiceAccount() || isLoggedIn();
        allow list: if isServiceAccount() || isLoggedIn();
      }
      match /responses/{responseId=**} {
        allow read: if isServiceAccount() || isPerson(resource.data.personId);
      }
      match /screens/{screenId=**} {
        allow read, write: if isServiceAccount();
      }
    }
  }
}
